<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Detailled statistics on {{ stats.cube_name }}">
    <meta name="generator" content="Term Timer">
    <meta name="pubdate" content="{{ now.strftime('%Y-%m-%d') }}">
    <title>Term Timer Statistics {{ stats.cube_name }}</title>
    <link href="/static/css/style.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.2.0/chartjs-plugin-zoom.min.js"></script>
    <script>
     document.addEventListener('DOMContentLoaded', function() {
       const tabs = document.querySelectorAll('.tab');
       const tabContents = document.querySelectorAll('.tab-content');

       tabs.forEach(tab => {
         tab.addEventListener('click', function() {
           tabs.forEach(t => t.classList.remove('active'));
           this.classList.add('active');
           tabContents.forEach(content => content.classList.remove('active'));

           const tabId = this.getAttribute('data-tab');
           document.getElementById(`${tabId}-tab`).classList.add('active');
         });
       });

       initializeProgressChart();
       initializeDistributionChart();
       initializeSortableTables();
       initializeScrambleCopy();
     });

     function initializeProgressChart() {
       const ctx = document.getElementById('progressChart');
       const totalPoints = {{ trend.indices|length }};

       const progressData = {
         labels: {{ trend.indices|tojson }},
         datasets: [
           {
             label: 'Time',
             data: {{ trend.times|tojson }},
             borderColor: '#2563ec',
             backgroundColor: 'rgba(37, 99, 236, 0.3)',
             tension: 0.2,
             borderWidth: 2,
             pointRadius: 2,
           },
           {% if stats.total >= 5 %}
           {
             label: 'AO5',
             data: {{ trend.ao5s|tojson }},
             borderColor: '#EF4444',
             backgroundColor: 'rgba(239, 68, 68, 0.3)',
             tension: 0.2,
             borderWidth: 2,
             pointRadius: 0,
           },
           {% endif %}
           {% if stats.total >= 12 %}
           {
             label: 'AO12',
             data: {{ trend.ao12s|tojson }},
             borderColor: '#10B981',
             backgroundColor: 'rgba(16, 185, 129, 0.3)',
             tension: 0.2,
             borderWidth: 2,
             pointRadius: 0,
           },
           {% endif %}
           {% if stats.total >= 100 %}
           {
             label: 'AO100',
             data: {{ trend.ao100s|tojson }},
             borderColor: '#64748B',
             backgroundColor: 'rgba(100, 116, 139, 0.3)',
             tension: 0.2,
             borderWidth: 2,
             pointRadius: 0,
           },
           {% endif %}
           {% if stats.total >= 1000 %}
           {
             label: 'AO1000',
             data: {{ trend.ao1000s|tojson }},
             borderColor: '#F8FAFC',
             backgroundColor: 'rgba(248, 250, 252, 0.3)',
             tension: 0.2,
             borderWidth: 2,
             pointRadius: 0,
           },
           {% endif %}
         ]
       };

       new Chart(ctx, {
         type: 'line',
         data: progressData,
         options: {
           responsive: true,
           maintainAspectRatio: false,
           plugins: {
             legend: {
               position: 'bottom',
               labels: {
                 color: '#94a3b8'
               }
             },
             tooltip: {
               mode: 'index',
               intersect: false,
               callbacks: {
                 title: function(tooltipItem) {
                   return `Solve #${tooltipItem[0].label}`;
                 }
               }
             },
             zoom: {
               pan: {
                 enabled: true,
                 mode: 'x'
               },
               limits: {
                 x: {
                   max: totalPoints
                 },
                 y: {
                   min: 0
                 }
               },
               zoom: {
                 wheel: {
                   enabled: true
                 },
                 pinch: {
                   enabled: true
                 },
                 mode: 'x'
               }
             }
           },
           scales: {
             x: {
               ticks: {
                 color: '#94a3b8'
               },
               grid: {
                 color: 'rgba(148, 163, 184, 0.1)'
               },
               min: totalPoints - 50,
               max: totalPoints
             },
             y: {
               ticks: {
                 color: '#94a3b8'
               },
               grid: {
                 color: 'rgba(148, 163, 184, 0.1)'
               }
             }
           }
         }
       });
     }

     function initializeDistributionChart() {
       const ctx = document.getElementById('timeDistributionChart');

       const bins = {{ distribution.labels|tojson }};
       const counts = {{ distribution.counts|tojson }};

       new Chart(ctx, {
         type: 'bar',
         data: {
           labels: bins,
           datasets: [{
             label: 'Solves',
             data: counts,
             borderColor: '#2563ec',
             backgroundColor: 'rgba(37, 99, 236, 0.6)',
             borderWidth: 1
           }]
         },
         options: {
           responsive: true,
           maintainAspectRatio: false,
           plugins: {
             legend: {
               display: false
             },
             tooltip: {
               callbacks: {
                 title: function(tooltipItem) {
                   return tooltipItem[0].label;
                 },
                 label: function(context) {
                   return `${context.parsed.y} solves`;
                 }
               }
             }
           },
           scales: {
             x: {
               title: {
                 display: true,
                 color: '#94a3b8'
               },
               ticks: {
                 color: '#94a3b8'
               },
               grid: {
                 color: 'rgba(148, 163, 184, 0.1)'
               }
             },
             y: {
               title: {
                 display: true,
                 text: 'Count',
                 color: '#94a3b8'
               },
               ticks: {
                 color: '#94a3b8'
               },
               grid: {
                 color: 'rgba(148, 163, 184, 0.1)'
               }
             }
           }
         }
       });
     }

     function initializeScrambleCopy() {
       const scrambleCells = document.querySelectorAll('.solve-scramble');

       scrambleCells.forEach(cell => {
         const tooltip = document.createElement('span');
         tooltip.className = 'copy-tooltip';
         cell.appendChild(tooltip);

         cell.addEventListener('click', function() {
           const scrambleText = this.textContent.trim();
           navigator.clipboard.writeText(scrambleText)
                    .then(() => {
                      this.classList.add('copied');
                      setTimeout(() => {
                        this.classList.remove('copied');
                      }, 2000);
                    })
                    .catch(err => {
                      console.error('Copy error: ', err);
                    });
         });
       });
     }

     function initializeSortableTables() {
       const tables = document.querySelectorAll('.table-container table');

       tables.forEach(table => {
         const headers = table.querySelectorAll('th');

         headers.forEach((header, index) => {
           header.addEventListener('click', function() {
             sortTable(table, index, this);
           });
         });
       });
     }

     function sortTable(table, columnIndex, header) {
       const rows = Array.from(table.querySelectorAll('tbody tr'));
       const isAsc = !header.classList.contains('sort-asc');

       table.querySelectorAll('th').forEach(th => {
         th.classList.remove('sort-asc', 'sort-desc');
       });

       header.classList.add(isAsc ? 'sort-asc' : 'sort-desc');

       rows.sort((a, b) => {
         let valueA = a.cells[columnIndex].textContent.trim();
         let valueB = b.cells[columnIndex].textContent.trim();

         if (/^\d{1,2}:\d{2}\.\d{2}$/.test(valueA) || /^\d{1,2}\.\d{2}$/.test(valueA)) {
           valueA = convertTimeToSeconds(valueA);
           valueB = convertTimeToSeconds(valueB);
           return isAsc ? valueA - valueB : valueB - valueA;
         }

         if (valueA.includes('%')) {
           valueA = parseFloat(valueA);
           valueB = parseFloat(valueB);
           return isAsc ? valueA - valueB : valueB - valueA;
         }

         if (!isNaN(valueA) && !isNaN(valueB)) {
           return isAsc ? valueA - valueB : valueB - valueA;
         }

         return isAsc
              ? valueA.localeCompare(valueB)
              : valueB.localeCompare(valueA);
       });

       const tbody = table.querySelector('tbody');
       rows.forEach(row => tbody.appendChild(row));
     }

     function convertTimeToSeconds(timeStr) {
       if (timeStr === '---') return Infinity;

       if (timeStr.includes(':')) {
         const [minutes, seconds] = timeStr.split(':');
         return parseFloat(minutes) * 60 + parseFloat(seconds);
       }

       return parseFloat(timeStr);
     }
    </script>
  </head>
  <body>
    <div class="container">
      <header>
        <div class="logo">
          <i class="fas fa-cube"></i>
          <h1>
            Term Timer Stats
            <span class="subtitle">{{ stats.cube_name }}</span>
          </h1>
        </div>
      </header>

      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Key Statistics</h2>
        </div>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-title">Total Solves</div>
            <div class="stat-value">{{ stats.total }}</div>
          </div>
          <div class="stat-card">
            <div class="stat-title">Total Time</div>
            <div class="stat-value">{{ stats.total_time|format_time }}</div>
          </div>
          <div class="stat-card">
            <div class="stat-title">Mean</div>
            <div class="stat-value">{{ stats.mean|format_time }}</div>
          </div>
          <div class="stat-card">
            <div class="stat-title">Median</div>
            <div class="stat-value">{{ stats.median|format_time }}</div>
          </div>
          <div class="stat-card">
            <div class="stat-title">Standard Deviation</div>
            <div class="stat-value">{{ stats.stdev|format_time }}</div>
          </div>
          {% if stats.total >= 2 %}
            <div class="stat-card">
              <div class="stat-title">Best</div>
              <div class="stat-value">{{ stats.best|format_time }}</div>
              {% if stats.total >= 3 %}
                <div class="stat-meta">
                  <span class="stat-best">BPA: {{ stats.bpa|format_time }}</span>
                  {% set delta = (stats.bpa - stats.best)|format_delta %}
                  <span class="stat-delta {% if '-' in delta %}negative{% else %}positive{% endif %}">
                    {{ delta }}
                  </span>
                </div>
              {% endif %}
            </div>
            <div class="stat-card">
              <div class="stat-title">Worst</div>
              <div class="stat-value">{{ stats.worst|format_time }}</div>
              {% if stats.total >= 3 %}
                <div class="stat-meta">
                  <span class="stat-worst">WPA: {{ stats.wpa|format_time }}</span>
                  {% set delta = (stats.wpa - stats.worst)|format_delta %}
                  <span class="stat-delta {% if '-' in delta %}negative{% else %}positive{% endif %}">
                    {{ delta }}
                  </span>
                </div>
              {% endif %}
            </div>
          {% endif %}
          {% if stats.total >= 3 %}
            <div class="stat-card">
              <div class="stat-title">Current Mo3</div>
              <div class="stat-value">{{ stats.mo3|format_time }}</div>
              <div class="stat-meta">
                <span class="stat-best">Best: {{ stats.best_mo3|format_time }}</span>
                {% set delta = (stats.mo3 - stats.best_mo3)|format_delta %}
                <span class="stat-delta {% if '-' in delta %}negative{% else %}positive{% endif %}">
                  {{ delta }}
                </span>
              </div>
            </div>
          {% endif %}
          {% if stats.total >= 5 %}
            <div class="stat-card">
              <div class="stat-title">Current Ao5</div>
              <div class="stat-value">{{ stats.ao5|format_time }}</div>
              <div class="stat-meta">
                <span class="stat-best">Best: {{ stats.best_ao5|format_time }}</span>
                {% set delta = (stats.ao5 - stats.best_ao5)|format_delta %}
                <span class="stat-delta {% if '-' in delta %}negative{% else %}positive{% endif %}">
                  {{ delta }}
                </span>
              </div>
            </div>
          {% endif %}
          {% if stats.total >= 12 %}
            <div class="stat-card">
              <div class="stat-title">Current Ao12</div>
              <div class="stat-value">{{ stats.ao12|format_time }}</div>
              <div class="stat-meta">
                <span class="stat-best">Best: {{ stats.best_ao12|format_time }}</span>
                {% set delta = (stats.ao12 - stats.best_ao12)|format_delta %}
                <span class="stat-delta {% if '-' in delta %}negative{% else %}positive{% endif %}">
                  {{ delta }}
                </span>
              </div>
            </div>
          {% endif %}
          {% if stats.total >= 100 %}
            <div class="stat-card">
              <div class="stat-title">Current Ao100</div>
              <div class="stat-value">{{ stats.ao100|format_time }}</div>
              <div class="stat-meta">
                <span class="stat-best">Best: {{ stats.best_ao100|format_time }}</span>
                {% set delta = (stats.ao100 - stats.best_ao100)|format_delta %}
                <span class="stat-delta {% if '-' in delta %}negative{% else %}positive{% endif %}">
                  {{ delta }}
                </span>
              </div>
            </div>
          {% endif %}
          {% if stats.total >= 1000 %}
            <div class="stat-card">
              <div class="stat-title">Current Ao1000</div>
              <div class="stat-value">{{ stats.ao1000|format_time }}</div>
              <div class="stat-meta">
                <span class="stat-best">Best: {{ stats.best_ao1000|format_time }}</span>
                {% set delta = (stats.ao1000 - stats.best_ao1000)|format_delta %}
                <span class="stat-delta {% if '-' in delta %}negative{% else %}positive{% endif %}">
                  {{ delta }}
                </span>
              </div>
            </div>
          {% endif %}
          {% if cfop.total %}
            <div class="stat-card">
              <div class="stat-title">CFOP Grade</div>
              <div class="stat-value">{{ cfop.mean|format_grade }}</div>
              <div class="stat-meta">
                <span class="stat-best">Mean: {{ cfop.mean|round(2) }}</span>
              </div>
            </div>
          {% endif %}
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Progress Over Time</h2>
        </div>
        <div class="chart-container">
          <canvas id="progressChart"></canvas>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Time Distribution</h2>
        </div>
        <div class="chart-container">
          <canvas id="timeDistributionChart"></canvas>
        </div>
      </div>


      <div class="card">
        <div class="tabs">
          <div class="tab active" data-tab="solves">Solves</div>
          <div class="tab" data-tab="oll">OLL</div>
          <div class="tab" data-tab="pll">PLL</div>
        </div>

        <div class="tab-content active table-container" id="solves-tab">
          <table class="solve-list">
            <thead>
              <tr>
                <th>#</th>
                <th>Time</th>
                <th>Date</th>
                <th>Scramble</th>
                <th>Flag</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for solve in stats.stack|reverse %}
              <tr>
                <td>{{ stats.stack|length - loop.index0 }}</td>
                <td class="solve-time {% if solve.time == stats.best %}time-best{% elif solve.time == stats.worst %}time-worst{% endif %}">
                  {{ solve.time|format_time }}
                  {% if solve.device %}
                    <span class="tooltip">{{ solve.device }}</span>
                  {% endif %}
                </td>
                <td class="solve-date">
                  {{ solve.datetime.strftime('%Y-%m-%d %H:%M') }}
                  <span class="tooltip">Session {{ solve.session|default('default', true) }}</span>
                </td>
                <td class="solve-scramble">
                  {{ solve.scramble }}
                </td>
                <td class="solve-flag">
                  {{ solve.flag|default('---', true) }}
                </td>
                <td>
                  {% if solve.raw_moves %}
                    <a href="{{ solve.link }}" target="_blank" class="solve-detail-btn">
                      Recons
                    </a>
                  {% else %}
                    ---
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="tab-content table-container" id="oll-tab">
          <table class="oll-list">
            <thead>
              <tr>
                <th>Case</th>
                <th>Count</th>
                <th>Frequency</th>
                <th>Probability</th>
                <th>Inspection</th>
                <th>Execution</th>
                <th>Time</th>
                <th>QTM</th>
                <th>TPS</th>
                <th>eTPS</th>
              </tr>
            </thead>
            <tbody>
              {% for name, oll in cfop.olls.items() %}
                <tr>
                  <td>
                    <div class="cfop-case">
                      {% set name_part = name.split(" ") %}
                      <div class="cfop-case-img">{{ name_part[0] }}</div>
                      {% if 'SKIP' not in name %}
                        <a href="https://cubing.fache.fr/OLL/{{ name_part[0] }}.html"
                           target="_blank" class="link">
                          {{ " ".join(name_part[1:]) }}
                        </a>
                      {% else %}
                        <span class="skip">SKIP</span>
                      {% endif %}
                    </div>
                  </td>
                  <td>
                    {{ oll.count }}
                  </td>
                  <td class="frequency-{% if oll.frequency > oll.probability %}higher{% else %}lower{% endif %}">
                    {{ (oll.frequency * 100)|round(2) }}%
                  </td>
                  <td>
                    {{ (oll.probability * 100)|round(2) }}%
                  </td>
                  <td>
                    {{ oll.inspection|format_duration }}
                  </td>
                  <td>
                    {{ oll.execution|format_duration }}
                  </td>
                  <td>
                    {{ oll.time|format_duration }}
                  </td>
                  <td>
                    {{ oll.qtm|round(2) }}
                  </td>
                  <td>
                    {{ oll.tps|round(2) }}
                  </td>
                  <td>
                    {{ oll.etps|round(2) }}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="tab-content table-container" id="pll-tab">
          <table class="pll-list">
            <thead>
              <tr>
                <th>Case</th>
                <th>Count</th>
                <th>Frequency</th>
                <th>Probability</th>
                <th>Inspection</th>
                <th>Execution</th>
                <th>Time</th>
                <th>QTM</th>
                <th>TPS</th>
                <th>eTPS</th>
              </tr>
            </thead>
            <tbody>
              {% for name, pll in cfop.plls.items() %}
                <tr>
                  <td>
                    <div class="cfop-case">
                      {% set name_part = name.split(" ") %}
                      <div class="cfop-case-img">{{ name_part[0] }}</div>
                      {% if 'SKIP' not in name %}
                        <a href="https://cubing.fache.fr/PLL/{{ name_part[0] }}.html"
                           target="_blank" class="link">
                          PLL {{ name }}
                        </a>
                      {% else %}
                        <span class="skip">SKIP</span>
                      {% endif %}
                    </div>
                  </td>
                  <td>
                    {{ pll.count }}
                  </td>
                  <td class="frequency-{% if pll.frequency > pll.probability %}higher{% else %}lower{% endif %}">
                    {{ (pll.frequency * 100)|round(2) }}%
                  </td>
                  <td>
                    {{ (pll.probability * 100)|round(2) }}%
                  </td>
                  <td>
                    {{ pll.inspection|format_duration }}
                  </td>
                  <td>
                    {{ pll.execution|format_duration }}
                  </td>
                  <td>
                    {{ pll.time|format_duration }}
                  </td>
                  <td>
                    {{ pll.qtm|round(2) }}
                  </td>
                  <td>
                    {{ pll.tps|round(2) }}
                  </td>
                  <td>
                    {{ pll.etps|round(2) }}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <footer class="app-footer card">
        <div class="footer-container">
          <div class="footer-section">
            <h3 class="footer-title">Report Informations</h3>
            <div class="footer-info">
              <div class="info-item">
                <i class="fas fa-cube"></i>
                <span class="key">Puzzle:</span>
                <span class="value">{{ stats.cube_name }}</span>
              </div>
              <div class="info-item">
                <i class="fas fa-clock"></i>
                <span class="key">Last solve:</span>
                <span class="value">{{ stats.stack[-1].datetime.strftime('%c') }}</span>
              </div>
              <div class="info-item">
                <i class="fas fa-calendar-alt"></i>
                <span class="key">Generation date:</span>
                <span class="value">{{ now.strftime('%c') }}</span>
              </div>
            </div>
          </div>

          <div class="footer-section">
            <h3 class="footer-title">Session{% if sessions|length > 1 %}s{% endif %}</h3>
            <div class="sessions-grid">
              {% for session, count in sessions.items() %}
                <div class="session-badge">
                  Session {{ session|default('default', true) }}
                  <span class="session-count">{{ count }}</span>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>

        <div class="footer-bottom">
          <div class="copyright">
            © {{ now.strftime('%Y') }} Term Timer
          </div>
        </div>
      </footer>
    </div>
  </body>
</html>
