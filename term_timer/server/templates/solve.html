{% extends "skeleton.html" %}

{% block description %}
  Solve #{{ solve_id }} from session {{ session }} on {{ cube }}x{{ cube }}x{{ cube }}
{% endblock %}

{% block title %}
  Solve #{{ solve_id }}
{% endblock %}

{% block subtitle %}
  Solve #{{ solve_id }}
{% endblock %}

{% block script %}
  <script>
   document.addEventListener('DOMContentLoaded', function() {
     const copiers = document.querySelectorAll('.moves-copy');

     copiers.forEach(copier => {
       copier.addEventListener('click', function() {
         const moves = copier.parentNode.parentNode.querySelector('.moves-content').textContent.trim().replace(/\s\s+/g, ' ');
         navigator.clipboard.writeText(moves).then(() => {
           this.textContent = 'Copied !';
           setTimeout(() => {
             this.textContent = 'Copy';
           }, 2000);
         }).catch(err => {
           console.error('Copy error: ', err);
         });
       });
     });
   });
  </script>
  {% if solve.advanced %}
    <script type="module">
     import { Alg, Move, Pause } from "https://cdn.cubing.net/v0/js/cubing/alg";
     import { TwistyAlgViewer, TwistyPlayer } from "https://cdn.cubing.net/v0/js/cubing/twisty";

     const solutionString = `{{ reconstruction }}`;
     const solutionMoveTimestamps = [{{ timing|join(', ') }}];

     const duration = solutionMoveTimestamps.at(-1);
     const parsedAlg = Alg.fromString(solutionString);

     const moves = Array.from(parsedAlg.childAlgNodes()).filter((algNode) =>
       algNode.is(Move) || algNode.is(Pause),
     );

     const animationTimelineLeaves = moves.map((move, i) => {
       return {
         animLeaf: move,
         start: solutionMoveTimestamps[i],
         end: solutionMoveTimestamps[i + 1] ?? duration + 1,
       };
     });

     const player = new TwistyPlayer({
       alg: parsedAlg,
       experimentalSetupAlg: "{{ cube_orientation }}",
       experimentalSetupAnchor: "end",
       viewerLink: "none",
       puzzle: "{{ cube }}x{{ cube }}x{{ cube }}",
       background: "none",
     });
     player.experimentalModel.animationTimelineLeavesRequest.set(
       animationTimelineLeaves,
     );
     document.querySelector("#replayer").appendChild(player);
     document.querySelector("#replayer").appendChild(new TwistyAlgViewer({ twistyPlayer: player }));
    </script>

    <script src="/static/js/Chart.js/3.7.1/chart.min.js"></script>
    <script src="/static/js/chartjs-plugin-annotation/2.2.1/chartjs-plugin-annotation.min.js"></script>
    <script>
     document.addEventListener('DOMContentLoaded', function() {

       const tabs = document.querySelectorAll('.tab');
       const tabContents = document.querySelectorAll('.tab-content');

       tabs.forEach(tab => {
         tab.addEventListener('click', function() {
           tabs.forEach(t => t.classList.remove('active'));
           this.classList.add('active');
           tabContents.forEach(content => content.classList.remove('active'));

           const tabId = this.getAttribute('data-tab');
           document.getElementById(`${tabId}-tab`).classList.add('active');
         });
       });

       initializeTimingChart();
       initializeTPSChart();
       initializeRecognitionChart();
       initializeSortableTables();
     });

   function initializeSortableTables() {
     const tables = document.querySelectorAll('.table-container table');

     tables.forEach(table => {
       const headers = table.querySelectorAll('th');

       headers.forEach((header, index) => {
         header.addEventListener('click', function() {
           sortTable(table, index, this);
         });
       });
     });
   }

   function sortTable(table, columnIndex, header) {
     const rows = Array.from(table.querySelectorAll('tbody tr'));
     const isAsc = !header.classList.contains('sort-asc');

     table.querySelectorAll('th').forEach(th => {
       th.classList.remove('sort-asc', 'sort-desc');
     });

     header.classList.add(isAsc ? 'sort-asc' : 'sort-desc');

     rows.sort((a, b) => {
       let valueA = a.cells[columnIndex].textContent.trim();
       let valueB = b.cells[columnIndex].textContent.trim();

       if (/^\d{1,2}:\d{2}\.\d{2}$/.test(valueA) || /^\d{1,2}\.\d{2}$/.test(valueA)) {
         valueA = convertTimeToSeconds(valueA);
         valueB = convertTimeToSeconds(valueB);
         return isAsc ? valueA - valueB : valueB - valueA;
       }

       if (valueA.includes('%')) {
         valueA = parseFloat(valueA);
         valueB = parseFloat(valueB);
         return isAsc ? valueA - valueB : valueB - valueA;
       }

       if (!isNaN(valueA) && !isNaN(valueB)) {
         return isAsc ? valueA - valueB : valueB - valueA;
       }

       return isAsc
            ? valueA.localeCompare(valueB)
            : valueB.localeCompare(valueA);
     });

     const tbody = table.querySelector('tbody');
     rows.forEach(row => tbody.appendChild(row));
   }

   function convertTimeToSeconds(timeStr) {
     if (timeStr === '---') return Infinity;

     if (timeStr.includes(':')) {
       const [minutes, seconds] = timeStr.split(':');
       return parseFloat(minutes) * 60 + parseFloat(seconds);
     }

     return parseFloat(timeStr);
   }

     function initializeRecognitionChart() {
       const ctx = document.getElementById('recognitionChart');
       const recog = {{ recognitions|tojson }};


       recogChart = new Chart(ctx, {
         type: 'bar',
         data: {
           labels: recog.map(item => item.label),
           datasets: [
             {
               label: 'Recognition',
               data: recog.map(item => item.recognition),
               backgroundColor: 'rgb(65, 131, 196)',
               borderColor: 'rgb(65, 131, 196)',
               borderWidth: 1,
             },
             {
               label: 'Execution',
               data: recog.map(item => item.execution),
               backgroundColor: 'rgb(231, 76, 31)',
               borderColor: 'rgb(231, 76, 31)',
               borderWidth: 1,
             },
           ],
         },
         options: {
           responsive: true,
           maintainAspectRatio: false,
           plugins: {
             legend: {
               display: false,
             },
             tooltip: {
               callbacks: {
                 label: function(context) {
                   return `${context.dataset.label}: ${context.parsed.y}s`;
                 },
               },
             },
           },
           scales: {
             x: {
               stacked: true,
               ticks: {
                 color: '#94a3b8',
               },
               grid: {
                 display: false,
               },
             },
             y: {
               stacked: true,
               title: {
                 display: true,
                 text: 'Time',
                 color: '#94a3b8',
               },
               ticks: {
                 stepSize: 1.0,
                 color: '#94a3b8',
               },
               grid: {
                 color: 'rgba(148, 163, 184, 0.1)',
               },
             },
           },
         },
       });
     }

     function initializeTPSChart() {
       const ctx = document.getElementById('tpsChart');
       const tps = {{ tps|tojson }};

       tpsChart = new Chart(ctx, {
         type: 'line',
         data: {
           labels: tps.map(item => item.label),
           datasets: [
             {
               label: 'TPS',
               data: tps.map(item => item.tps),
               borderColor: 'rgba(75, 192, 75, 0.6)',
               tension: 0.1,
               fill: false,
               pointBackgroundColor: 'rgba(75, 192, 75, 0.6)',
               pointRadius: 5,
               pointHitRadius: 5,
               pointHoverRadius: 10,
             },
             {
               label: 'eTPS',
               data: tps.map(item => item.etps),
               borderColor: 'rgba(37, 99, 236, 0.6)',
               pointBackgroundColor: 'rgba(37, 99, 236, 0.6)',
               tension: 0.1,
               fill: false,
               pointRadius: 5,
               pointHitRadius: 5,
               pointHoverRadius: 10,
             },
           ]
         },
         options: {
           responsive: true,
           maintainAspectRatio: false,
           plugins: {
             legend: {
               display: false
             },
             annotation: {
               annotations: [{
                 type: 'line',
                 yMin: {{ solve.tps }},
                 yMax: {{ solve.tps }},
                 borderColor: 'rgba(255, 0, 0, 0.6)',
                 borderWidth: 2,
               }],
             },
           },
           scales: {
             x: {
               ticks: {
                 color: '#94a3b8',
               },
               grid: {
                 color: 'rgba(148, 163, 184, 0.1)',
               }
             },
             y: {
               beginAtZero: true,
               title: {
                 display: true,
                 text: 'TPS (Turns Per Second)',
                 color: '#94a3b8'
               },
               grid: {
                 color: 'rgba(148, 163, 184, 0.1)',
               },
               ticks: {
                 color: '#94a3b8',
               },
             },
           },
         }
       });
     }

     function initializeTimingChart() {
       const ctx = document.getElementById('timingChart');
       const steps = {{ steps|tojson }};

       new Chart(ctx, {
         type: 'scatter',
         data: {
           datasets: [{
             label: 'Moves',
             data: {{ scatter|tojson }},
             borderColor: '#2563EC',
             backgroundColor: 'rgba(37, 99, 236, 0.6)',
             borderWidth: 2,
             pointRadius: 2,
             pointHitRadius: 6,
             pointHoverRadius: 8,
           }]
         },
         options: {
           responsive: true,
           maintainAspectRatio: false,
           plugins: {
             legend: {
               display: false
             },
             tooltip: {
               callbacks: {
                 title: function(tooltipItem) {
                   return `Move #${tooltipItem[0].label}`;
                 },
                 label: function(context) {
                   return `${context.parsed.y}s`;
                 },
               },
             },
             annotation: {
               annotations: steps.map(line => ({
                 type: 'line',
                 xMin: line.x,
                 xMax: line.x,
                 borderColor: 'rgba(255, 0, 0, 0.8)',
                 borderWidth: 2,
               }))
             },
           },
           scales: {
             x: {
               type: 'linear',
               min: 0,
               max: {{ scatter|length }} + 1,
               ticks: {
                 display: true,
                 autoSkip: false,
                 major: true,
                 color: '#94a3b8',
                 callback: function(value) {
                   const line = steps.find(l => l.x === value);
                   return line ? line.label : '';
                 },
               },
               afterBuildTicks: (axis) => {
                 axis.ticks = steps.map(line => ({
                   value: line.x,
                 }));
                 return;
               },
               grid: {
                 color: 'rgba(148, 163, 184, 0.1)',
               }
             },
             y: {
               min: -1,
               max: Math.ceil({{ scatter[-1].y }}) + 1,
               title: {
                 display: true,
                 text: 'Time',
                 color: '#94a3b8'
               },
               ticks: {
                 color: '#94a3b8',
                 major: true,
                 callback: function(value) {
                   const line = steps.find(l => l.y === value);
                   return line ? line.y : '';
                 },
               },
               afterBuildTicks: (axis) => {
                 axis.ticks = steps.map(line => ({
                   value: line.y,
                 }));
                 return;
               },
               grid: {
                 color: 'rgba(148, 163, 184, 0.1)'
               }
             }
           }
         }
       });
     }
    </script>
  {% endif %}
{% endblock %}

{% block body %}
  <div class="card">
    <div class="card-header">
      <h2 class="card-title">
        <a href="#informations" id="informations">Informations</a>
      </h2>
    </div>
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-title">Time</div>
        <div class="stat-value {% if rank == 1 %}stat-best{% elif rank == solves|length %}stat-worst{% endif %}">{{ solve.final_time|format_time }}</div>
        <div class="stat-meta">
          #{{ rank }}
        </div>
      </div>
      {% if solve.flag %}
        <div class="stat-card">
          <div class="stat-title">Flag</div>
          <div class="stat-value">{{ solve.flag }}</div>
        </div>
      {% endif %}
      <div class="stat-card">
        <div class="stat-title">Date</div>
        <div class="stat-value">
          {{ solve.datetime.strftime('%Y-%m-%d') }}
        </div>
        <div class="stat-meta">
          {{ solve.datetime.strftime('%H:%M') }}
        </div>
      </div>
      {% if solve.device %}
        <div class="stat-card">
          <div class="stat-title">Cube</div>
          <div class="stat-value">{{ solve.device }}</div>
        </div>
      {% endif %}
      <div class="stat-card">
        <div class="stat-title">Timer</div>
        <div class="stat-value">
          {% if solve.timer == "Cubeast" %}
            <a href="https://app.cubeast.com/" target="_blank" class="link">
              {{ solve.timer }}
            </a>
          {% elif solve.timer == "csTimer" %}
            <a href="https://cstimer.net/" target="_blank" class="link">
              {{ solve.timer }}
            </a>
          {% else %}
            {{ solve.timer }}
          {% endif %}
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-title">Session</div>
        <div class="stat-value">
          <a href="/{{ cube }}/{{ session|default('default', true) }}/" class="link">
            {{ session|default('default', true)|title }}
          </a>
        </div>
      </div>
      {% if solve.raw_moves %}
        <div class="stat-card">
          <div class="stat-title">Links</div>
          <div class="stat-value">
            <a href="{{ solve.link_alg_cubing }}" target="_blank"
               title="View solution on alg.cubing.net"
               class="solve-detail-btn alg-cubing">
              Alg Cubing
            </a>
            <a href="{{ solve.link_cube_db }}" target="_blank"
               title="View solution on cubedb.net"
               class="solve-detail-btn cube-db">
              Cube DB
            </a>
          </div>
        </div>
      {% endif %}
    </div>
  </div>

  {% if solve.advanced %}
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">
          <a href="#statistics" id="statistics">Key Statistics</a>
        </h2>
      </div>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-title">Grade</div>
          <div class="stat-value grade-{{ solve.score|format_grade|lower|replace('+', 'plus') }}">
            {{ solve.score|format_grade }}
          </div>
          <div class="stat-meta">
            {{ solve.score|format_score }}
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-title">Grade {{ solve.method_name|upper  }}</div>
          <div class="stat-value grade-{{ solve.method_applied.score|format_grade|lower|replace('+', 'plus') }}">
            {{ solve.method_applied.score|format_grade }}
          </div>
          <div class="stat-meta">
            {{ solve.method_applied.score|format_score }}
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-title">Recognition</div>
          <div class="stat-value">
            {{ (solve.recognition_time / solve.time * 100.0)| normalize_percent(solve.method_applied, 'solve', 'recognition') }}
          </div>
          <div class="stat-meta">
            <span class="stat-best">{{ solve.recognition_time|format_duration }}s</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-title">Execution</div>
          <div class="stat-value">
            {{ (solve.execution_time / solve.time * 100.0)| normalize_percent(solve.method_applied, 'solve', 'execution') }}
          </div>
          <div class="stat-meta">
            <span class="stat-best">{{ solve.execution_time|format_duration }}s</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-title">TPS</div>
          <div class="stat-value">
            {{ "%0.2f"|format(solve.tps) }}
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-title">Move Speed</div>
          <div class="stat-value">
            {{ solve.move_speed|format_duration }}s
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-title">HTM</div>
          <div class="stat-value">{{ solve.reconstruction.metrics.htm }}</div>
        </div>
        {% if solve.reconstruction.metrics.htm != solve.reconstruction.metrics.qtm %}
          <div class="stat-card">
            <div class="stat-title">QTM</div>
            <div class="stat-value">{{ solve.reconstruction.metrics.qtm }}</div>
          </div>
        {% endif %}
        {% if solve.reconstruction.metrics.qtm != solve.reconstruction.metrics.qstm %}
          <div class="stat-card">
            <div class="stat-title">QSTM</div>
            <div class="stat-value">{{ solve.reconstruction.metrics.qstm }}</div>
          </div>
        {% endif %}
        {% if solve.execution_missed_moves %}
          <div class="stat-card">
            <div class="stat-title">Execution Overhead</div>
            <div class="stat-value stat-{% if solve.execution_missed_moves > 3 %}worst{% else %}warning{% endif %}">
              {{ solve.execution_missed_moves }}
            </div>
          </div>
        {% endif %}
        {% if solve.transition_missed_moves %}
          <div class="stat-card">
            <div class="stat-title">Transition Overhead</div>
            <div class="stat-value stat-{% if solve.transition_missed_moves > 3 %}worst{% else %}warning{% endif %}">
              {{ solve.transition_missed_moves }}
            </div>
          </div>
        {% endif %}
        {% if solve.execution_pauses %}
          <div class="stat-card">
            <div class="stat-title">Execution Pauses</div>
            <div class="stat-value stat-{% if solve.execution_pauses > 4 %}worst{% else %}warning{% endif %}">
              {{ solve.execution_pauses }}
            </div>
          </div>
        {% endif %}
      </div>
    </div>
  {% endif %}

  <div class="card">
    <div class="card-header">
      <h2 class="card-title">
        <a href="#scramble" id="scramble">Scramble</a>
      </h2>
    </div>
    <div class="scramble-card moves-card">
      <div class="moves-content">
      {% for m in solve.scramble.split(' ') %}
        <span class="move">{{ m }}</span>
      {% endfor %}
      </div>
      <div class="moves-footer">
        {{ solve.scramble.split(' ')|length }} HTM - Computer generated -
        <button class="moves-copy">Copy</button>
      </div>
    </div>
  </div>

  {% if solve.advanced %}
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">
          <a href="#solution" id="solution">Solution</a>
        </h2>
      </div>
      {% set solution = solve.solution|solution %}
      <div class="solution-card moves-card">
        <div class="moves-content">
          {% for m in solution %}
            <span class="move">{{ m }}</span>
          {% endfor %}
        </div>
        <div class="moves-footer">
          {{ solution.metrics.htm }} HTM - Human generated -
          <button class="moves-copy">Copy</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h2 class="card-title">
          <a href="#replay" id="replay">Replay</a>
        </h2>
      </div>
      <div class="replay-container">
        <div id="replayer"></div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h2 class="card-title">
          <a href="#reconstruction" id="reconstruction">Reconstruction</a>
        </h2>
        {% if cube_orientation %}
          <div class="orientation">
            <span class="move">{{ cube_orientation }}</span>
          </div>
        {% endif %}
      </div>

      <div class="tabs">
        <div class="tab active" data-tab="solve-time">Time</div>
        <div class="tab" data-tab="solve-percent">Percent</div>
        <div class="tab" data-tab="solve-issues">Issues</div>
      </div>

      <div class="tab-content active table-container" id="solve-time-tab">
        <table class="reconstruction">
          <thead>
            <tr>
              <th>Step</th>
              <th>Case</th>
              <th>Moves</th>
              <th>Recognition</th>
              <th>Execution</th>
              <th>Time</th>
              <th>HTM</th>
              <th>QTM</th>
              <th>TPS</th>
              <th>eTPS</th>
            </tr>
          </thead>
          <tbody>
            {% for info in solve.method_applied.summary %}
              <tr class="{% if info.type == 'substep' %}substep{% endif %}">
                <td class="recons-step">
                  {{ info.name }}
                </td>
                <td class="recons-case">
                  <div class="cfop-case">
                    {% if info.cases %}
                      {% set name_part = info.cases[0].split(" ") %}
                      <div class="cfop-case-img">{{ name_part[0] }}</div>
                      {% if 'SKIP' not in name %}
                        {% if info.name == 'OLL' %}
                          <a href="https://cubing.fache.fr/OLL/{{ name_part[0] }}.html"
                             target="_blank" class="link">
                            {{ " ".join(name_part[1:]) }}
                          </a>
                        {% elif info.name == 'PLL' %}
                          <a href="https://cubing.fache.fr/PLL/{{ name_part[0] }}.html"
                             target="_blank" class="link">
                            PLL {{ name_part[0] }}
                          </a>
                        {% endif %}
                      {% else %}
                        <span class="skip">SKIP</span>
                      {% endif %}
                    {% else %}
                      <div class="cfop-case-img">N/A</div>
                    {% endif %}
                  </div>
                </td>
                <td class="recons-moves">
                  {{ info.reconstruction }}
                </td>
                <td class="recons-recognition">
                  {{ info.recognition|format_duration }}
                </td>
                <td class="recons-execution">
                  {{ info.execution|format_duration }}
                </td>
                <td class="recons-total">
                  {{ info.total|format_duration }}
                </td>
                <td class="recons-htm">
                  {{ info.reconstruction.metrics.htm|normalize_value(solve.method_applied, 'moves', info.name) }}
                </td>
                <td class="recons-qtm">
                  {{ info.reconstruction.metrics.qtm }}
                </td>
                <td class="recons-tps">
                  {{ solve.compute_tps(info.qtm, info.total)|round(2) }}
                </td>
                <td class="recons-etps">
                  {{ solve.compute_tps(info.qtm, info.execution)|round(2) }}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="tab-content table-container" id="solve-percent-tab">
        <table class="reconstruction">
          <thead>
            <tr>
              <th>Step</th>
              <th>Case</th>
              <th>Moves</th>
              <th>Recognition</th>
              <th>Execution</th>
              <th>Time</th>
              <th>Step Reco.</th>
              <th>Step Exec.</th>
            </tr>
          </thead>
          <tbody>
            {% for info in solve.method_applied.summary %}
              <tr class="{% if info.type == 'substep' %}substep{% endif %}">
                <td class="recons-step">
                  {{ info.name }}
                </td>
                <td class="recons-case">
                  <div class="cfop-case">
                    {% if info.cases %}
                      {% set name_part = info.cases[0].split(" ") %}
                      <div class="cfop-case-img">{{ name_part[0] }}</div>
                      {% if 'SKIP' not in name %}
                        {% if info.name == 'OLL' %}
                          <a href="https://cubing.fache.fr/OLL/{{ name_part[0] }}.html"
                             target="_blank" class="link">
                            {{ " ".join(name_part[1:]) }}
                          </a>
                        {% elif info.name == 'PLL' %}
                          <a href="https://cubing.fache.fr/PLL/{{ name_part[0] }}.html"
                             target="_blank" class="link">
                            PLL {{ name_part[0] }}
                          </a>
                        {% endif %}
                      {% else %}
                        <span class="skip">SKIP</span>
                      {% endif %}
                    {% else %}
                      <div class="cfop-case-img">N/A</div>
                    {% endif %}
                  </div>
                </td>
                <td class="recons-moves">
                  {{ info.reconstruction }}
                </td>
                <td class="recons-recognition">
                  {{ "%0.2f"|format(info.recognition_percent) }}%
                </td>
                <td class="recons-execution">
                  {{ "%0.2f"|format(info.execution_percent) }}%
                </td>
                <td class="recons-total">
                  {{ info.total_percent|normalize_percent(solve.method_applied, 'percent', info.name) }}
                </td>
                <td class="recons-local-recognition">
                  {{ info.step_recognition_percent|normalize_percent(solve.method_applied, 'recognition', info.name) }}
                </td>
                <td class="recons-local-execution">
                  {{ info.step_execution_percent|normalize_percent(solve.method_applied, 'execution', info.name) }}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="tab-content table-container" id="solve-issues-tab">
        <table class="reconstruction">
          <thead>
            <tr>
              <th>Step</th>
              <th>Case</th>
              <th>Moves</th>
              <th>QTM Overhead</th>
              <th>Execution Pauses</th>
            </tr>
          </thead>
          <tbody>
            {% for info in solve.method_applied.summary %}
              <tr class="{% if info.type == 'substep' %}substep{% endif %}">
                <td class="recons-step">
                  {{ info.name }}
                </td>
                <td class="recons-case">
                  <div class="cfop-case">
                    {% if info.cases %}
                      {% set name_part = info.cases[0].split(" ") %}
                      <div class="cfop-case-img">{{ name_part[0] }}</div>
                      {% if 'SKIP' not in name %}
                        {% if info.name == 'OLL' %}
                          <a href="https://cubing.fache.fr/OLL/{{ name_part[0] }}.html"
                             target="_blank" class="link">
                            {{ " ".join(name_part[1:]) }}
                          </a>
                        {% elif info.name == 'PLL' %}
                          <a href="https://cubing.fache.fr/PLL/{{ name_part[0] }}.html"
                             target="_blank" class="link">
                            PLL {{ name_part[0] }}
                          </a>
                        {% endif %}
                      {% else %}
                        <span class="skip">SKIP</span>
                      {% endif %}
                    {% else %}
                      <div class="cfop-case-img">N/A</div>
                    {% endif %}
                  </div>
                </td>
                <td class="recons-moves">
                  {{ solve.reconstruction_step_line(info, multiple=True)|style_issues }}
                </td>
                <td class="recons-overhead">
                  {% set missed_moves = solve.missed_moves(info.reconstruction_timed) %}
                  <span class="metric-{% if missed_moves > 2 %}warning{% elif missed_moves %}caution{% else %}success{% endif %}">
                  {{ missed_moves }}
                </td>
                <td class="recons-pauses">
                  {% set pauses = solve.pauses(info.reconstruction_timed) %}
                  <span class="metric-{% if pauses >= 2 %}warning{% elif pauses %}caution{% else %}success{% endif %}">
                    {{ pauses }}
                  </span>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

    </div>

    <div class="card">
      <div class="card-header">
        <h2 class="card-title">
          <a href="#timing-chart" id="timing-chart">Timing Chart</a>
        </h2>
      </div>
      <div class="chart-container">
        <canvas id="timingChart"></canvas>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h2 class="card-title">
          <a href="#tps" id="tps">TPS</a>
        </h2>
      </div>
      <div class="chart-container">
        <canvas id="tpsChart"></canvas>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h2 class="card-title">
          <a href="#recognition" id="recognition">Recognition</a>
        </h2>
      </div>
      <div class="chart-container">
        <canvas id="recognitionChart"></canvas>
      </div>
    </div>

    {% if DEBUG %}
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">
            <a href="#raw-moves" id="raw-moves">Raw Moves</a>
          </h2>
        </div>
        <div class="solution-card moves-card">
          <div class="moves-content">
            {% for m in solve.solution %}
              <span class="move">{{ m }}</span>
            {% endfor %}
          </div>
          <div class="moves-footer">
            {{ solve.solution.metrics.qtm }} QTM - Raw Moves -
            <button class="moves-copy">Copy</button>
          </div>
        </div>
      </div>
    {% endif %}

  {% endif %}

  <footer class="app-footer card">
    <div class="footer-container">
      <div class="footer-section">
        <h3 class="footer-title">Report Informations</h3>
        <div class="footer-info">
          <div class="info-item">
            <i class="fas fa-cube"></i>
            <span class="key">Puzzle:</span>
            <span class="value">{{ cube }}x{{ cube }}x{{ cube }}</span>
          </div>
          <div class="info-item">
            <i class="fas fa-calendar-alt"></i>
            <span class="key">Generation date:</span>
            <span class="value">{{ now.strftime('%c %Z') }}</span>
          </div>
        </div>
      </div>

      <div class="footer-section">
        <h3 class="footer-title">Session</h3>
        <div class="sessions-grid">
          <a class="session-badge" href="/{{ cube }}/{{ session|default('default', true) }}/">
            Session {{ session|default('default', true) }}
            <span class="session-count">{{ solves|length }}</span>
          </a>
        </div>
      </div>
    </div>

    <div class="footer-bottom">
      <div class="copyright">
        © {{ now.strftime('%Y') }} Term Timer
      </div>
    </div>
  </footer>

{% endblock %}
